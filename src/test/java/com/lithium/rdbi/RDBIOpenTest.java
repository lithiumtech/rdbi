package com.lithium.rdbi;


import org.testng.annotations.Test;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.exceptions.JedisException;

public class RDBIOpenTest {

    static interface TestDAO {
        @RedisQuery("doesn't matter")
        public int doesntMatter();
    }

    @Test
    public void testOpenAttach() {
        RDBI rdbi = new RDBI(RDBITest.getJedisPool());

        TestDAO dao = rdbi.open(TestDAO.class);
        dao.doesntMatter();
        rdbi.close(dao);
    }

    @Test
    public void testOpenAttachCloseBroken() {
        RDBI rdbi = new RDBI(RDBITest.getJedisPool());

        TestDAO dao = rdbi.open(TestDAO.class);
        dao.doesntMatter();
        rdbi.closeBroken(dao);
    }

    @Test(expectedExceptions = JedisException.class)
    public void testOpenThrow() {
        RDBI rdbi = new RDBI(RDBITest.getBadJedisPool());
        rdbi.open(TestDAO.class);
    }

    @Test(expectedExceptions = Exception.class)
    public void testOpenThrowRuntimeException() {
        RDBI rdbi = new RDBI(RDBITest.getBadJedisPoolWithRuntimeException());
        rdbi.open(TestDAO.class);
    }

    @Test
    public void testGetJedis() {
        RDBI rdbi = new RDBI(RDBITest.getJedisPool());
        Jedis jedis = rdbi.getJedis();
        rdbi.returnJedis(jedis);

        Jedis jedis2 = rdbi.getJedis();
        rdbi.returnBrokenJedis(jedis2);
    }
}
